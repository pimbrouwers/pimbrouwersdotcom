<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1"><meta name=author content="Pim Brouwers"><meta name=description content="The musings of a curious developer. Driven by problems. Inspired by solutions."><meta name=google-site-verification content=iG1XdnX4f9LBgkELpy_fTAfKRLnLcLCWj6ZpC_NlbYI><link rel=icon href=../favicon.png><title>How to Replace a Production SQL Table Without Downtime (Almost) | Pim Brouwers</title><link rel=stylesheet href=http://yui.yahooapis.com/pure/0.6.0/pure-min.css><!--[if lte IE 8]>
 
 <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-old-ie-min.css">
 
<![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]>
 <link rel="stylesheet" href="css/layouts/blog-old-ie.css">
 <![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet type=text/css href=../css/style.min.css><!--<![endif]--><link rel=stylesheet type=text/css href=https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-8-24 pure-u-lg-1-4"><div class=header><h1 class=brand-title><a href="/" title=Home>PIM BROUWERS</a></h1><!--<h2 class="brand-tagline">01110000 01101001 01101101</h2>--><h2 class=brand-tagline>Curious developer, fitness enthusiast and chair raver.</h2><nav class=nav><ul class=nav-list><li class=nav-item><a class=pure-button target=_blank title="Pim Brouwers' Stack Overflow Profile" href=http://stackoverflow.com/users/2421277/jiminygillickrs><span class="fa fa-stack-overflow"></span> Stack Overflow</a></li><li class=nav-item><a class=pure-button target=_blank title="Pim Brouwers' GitHub Profile" href=https://github.com/pimbrouwers><span class="fa fa-github-square"></span> GitHub</a></li><li class=nav-item><a class=pure-button target=_blank title="Pim Brouwers' LinkedIn Profile" href="http://ca.linkedin.com/pub/pim-brouwers/4b/3a3/223/"><span class="fa fa-linkedin-square"></span> LinkedIn</a></li></ul></nav></div></div><div class="content pure-u-1 pure-u-md-16-24 pure-u-lg-3-4"><!--All Posts--><div class=posts><h1 class=content-subhead>By <a href=https://plus.google.com/u/0/111830860305577267596/about rel=author target=_blank class=post-author>Pim Brouwers</a></h1><!--Post--><section class=post><header class=post-header><!--<img class="post-avatar" alt="Pim Brouwers&#x27;s avatar" height="48" width="48" src="../images/self.png">--><h2 class=post-title>How to Replace a Production SQL Table Without Downtime (Almost)</h2><p class=post-meta><a href=../tag/SQL>SQL</a></p></header><div class=post-description><p></p><p>There are instances when a production SQL table, or the data within it, needs to be modified in some way and significant downtime is not an option. I was recently confronted with this situation when a rogue script/code had injected millions (literally) of duplicate records into one of our production system tables.</p><p>My first thought was to write a simple &quot;DELETE FROM...&quot; query to expunge the duplicates, but given the sheer number of rows, the writes to the transaction log and of course the indexes/constraints on the table, this option would have an extensive execution time. Factoring in that downtime wasn&#39;t acceptable in this case, I had to come up with a solution that would essentially be &quot;instantaneous&quot;. Here&#39;s what I came up with:</p><p>To begin, we need to recreate the table.</p><pre><code class=lang-sql>CREATE TABLE [dbo].[tmp_YourTable](
    [id] [int] IDENTITY(1,1) NOT NULL,
    [someCol1] [int] NOT NULL,
    [someCol2] [int] NOT NULL,
    [someCol3] [int] NOT NULL,    
 CONSTRAINT [tmp_YourTable_PK_v2] PRIMARY KEY CLUSTERED 
(
    [id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)

GO

ALTER TABLE [dbo].[tmp_YourTable]  WITH CHECK ADD  CONSTRAINT [SomeOtherTable_tmp_YourTable_FK1_v2] FOREIGN KEY([someCol1])
REFERENCES [dbo].[SomeOtherTable]([someCol1])
GO

ALTER TABLE [dbo].[tmp_YourTable] CHECK CONSTRAINT [SomeOtherTable_tmp_YourTable_FK1_v2]
GO
</code></pre><p>Next, we need to write a query to get the unique records from our original table and insert them into our new table. It&#39;s critical to enable IDENTITY_INSERT to allow us to write values to the PK.</p><pre><code class=lang-sql>SET IDENTITY_INSERT tmp_YourTable ON

INSERT INTO tmp_YourTable (id, someCol1, someCol2, someCol3)
select max(id) as id, pageItemID, someCol1, someCol2, someCol3
from YourTable with (nolock)
GROUP BY id, someCol1, someCol2, someCol3

SET IDENTITY_INSERT tmp_YourTable OFF
GO
</code></pre><p>Finally, we do the always scary table rename.</p><pre><code class=lang-sql>BEGIN TRANSACTION;  
    DROP TABLE [dbo].[YourTable]
    GO

    EXEC sp_rename &#39;tmp_YourTable&#39;, &#39;YourTable&#39;;
COMMIT TRANSACTION;
</code></pre><p>And there you have it, we swapped a production table with little to no down time whatsoever.</p><p></p></div></section></div><div class=pagination><a href="/" onclick=window.history.back();>&laquo; Back</a></div></div></div><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js></script><script>if(hljs) hljs.initHighlightingOnLoad();</script></body></html>