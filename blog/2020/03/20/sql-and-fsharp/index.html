<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width,initial-scale=1" name="viewport">
	<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
	<title>SQL |> F# Starting small and finishing big</title>	
	<link rel="apple-touch-icon" sizes="57x57" href="/assets/fav/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/assets/fav/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/fav/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/assets/fav/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/assets/fav/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/assets/fav/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/fav/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/assets/fav/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/assets/fav/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="/assets/fav/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/assets/fav/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/assets/fav/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/assets/fav/favicon-16x16.png">
	<link rel="manifest" href="/assets/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">
	<meta name="author" content="Pim Brouwers" />
	<meta name="keywords" content="pim brouwers programming f# sql powershell" />
	<meta content="" name="description">	
	<meta content="SQL |> F# Starting small and finishing big" property="og:title">
	<meta content="" property="og:description">
	<meta content="?s=300" property="og:image">
	<meta content="510673212" property="twitter:account_id">
	<meta content="summary" name="twitter:card">
	<meta content="@pim_brouwers" name="twitter:site">
	<meta content="@pim_brouwers" name="twitter:creator">
	<meta name="google-site-verification" content="iG1XdnX4f9LBgkELpy_fTAfKRLnLcLCWj6ZpC_NlbYI" />
	<link href="/assets/style.css" rel="stylesheet" type="text/css">
</head>
<body>
	<header>
		<nav>
			<div class="nav-brand">Pim Brouwers</div>
			<a class="nav-link" href="/">Home</a>
			<a class="nav-link" href="/about">About</a>
			<a class="nav-link" href="/blog" class="mr1">Blog</a>   
		</nav>
	</header>
	<main>
		<article>
			<div class="blog-date">2020/03/20</div>
<h1 class="blog-title">SQL |> F#: Starting small and finishing big</h1>

<p>I often times think that people new to F# are so drawn to all the fancy toys that it can be easy to lose sight of the fact that it's still just plain old .NET.</p>

<p>With that said, in the spirit of starting small and finishing big, we'll look at the simple task of working with a relational database.</p>

<p>Rather than immediately reaching for one of the libraries like SqlProvider (which is an excellent tool, but not the point here), we'll stick to just ADO.</p>

<p>To achieve a very useful module you actually need very little code, which is one of the major benefits of F# in my opinion. For our simple scope, we know we need:</p>

<ul>
    <li>A way to create connections (i.e. connection factory)
        <code><pre>let newConnection connectionString =
    let conn = new SqlConnection(connectionString)
    conn.Open()
    conn</pre></code>
    </li>
    <li>A way to execute statements (i.e. INSERT, UPDATE)
        <code><pre>let exec sql param conn =
    let cmd = newCommand sql param conn
    cmd.ExecuteNonQuery()</pre></code>
    </li>
    <li>A way to query records (i.e. SELECT)
        <code><pre>let query sql param map conn =
    let cmd = newCommand sql param conn
    use rd = cmd.ExecuteReader()
    [ while rd.Read() do
        yield map rd ]</pre></code>
    </li>
</ul>

<p>To support the above syntax we'll create ourselves a module called SQL, import <code>System.Data</code> and for this example we'll use <code>System.Data.SqlClient</code> (though you could sub this with any vendor). Once we've gotten our dependencies imported, creating wrapper for ADO becomes trivial.</p>

<code><pre>module SQL =
open System.Data
open System.Data.SqlClient

let newConnection (connectionString : string) =
    let conn = new SqlConnection(connectionString)
    conn.Open()
    conn

let createParameter (cmd: SqlCommand) (name : string, value : obj) =
    let p = cmd.CreateParameter()
    p.ParameterName <- name
    p.Value <- value
    p

let addParameter (cmd: SqlCommand) (p : SqlParameter) = 
    cmd.Parameters.Add(p) |> ignore

let newCommand 
    (sql : string) 
    (parameters : seq&lt;string * obj&gt; 
    (conn : IDbConnection) =        
    let cmd = new SqlCommand(connection = conn, cmdText = sql)
    cmd.CommandType <- CommandType.Text        

    let createParam = createParameter cmd
    let addParam = addParameter cmd
    parameters 
    |> Seq.iter (fun p -> p |> createParam |> addParam)
    cmd 

let exec 
    (sql : string) 
    (parameters : seq&lt;string * obj&gt; 
    (conn : IDbConnection) =        
    let cmd = newCommand sql param conn
    cmd.ExecuteNonQuery()

let query 
    (sql : string) 
    (parameters : seq&lt;string * obj&gt; 
    (conn : IDbConnection) =        
    let cmd = newCommand sql param conn
    use rd = cmd.ExecuteReader()
    [ while rd.Read() do
        yield map rd ]</pre></code>

<blockquote>Notice that there is mutation happening here (anywhere you see <code><-</code>). But that's okay because we've tucked it away and sand boxed it with a function wrapper.</blockquote>

<p>So in about 30 lines of code we've created ourselves a small, well-understood and self documenting solution that can help us fully achieve the goal of interacting with a database. Pretty sweet!</p>

<p>If you find this approach helpful, feel free to checkout my OS project <a href="https://github.com/pimbrouwers/Donald" target="_blank">Donald</a>, a well-tested, idiomatic F# wrapper for ADO.NET (note: it is NOT vendor specific).</p>
		</article>	
	</main>
</body>
</html>

