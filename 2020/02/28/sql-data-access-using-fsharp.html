<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <title>SQL |> F#: Simple & powerful data access for .NET | Pim Brouwers</title> 
  <link href="/style.css" rel="stylesheet" type="text/css">
</head>

<body>
  <header>    
    <p><a href="/">&laquo; Go back</a></p>
    <h1>SQL |> F#: Simple & powerful data access for .NET</h1>        
    <p class="big">I often times think that people new to F# are so drawn to all the fancy toys that it can be easy to lose sight of the fact that it's still just plain old .NET.</p>

  </header>

  <hr/>

  <small class="muted monospace">FEBRUARY 28, 2020</small>

  <p>With that said, in the spirit of starting small and finishing big, we'll look at the simple task of working with a relational database.</p>

  <p>Rather than immediately reaching for one of the libraries like SqlProvider (which is an excellent tool, but not the point here), we'll stick to just ADO.</p>

  <p>To achieve a very useful module you actually need very little code, which is one of the major benefits of F# in my opinion. For our simple scope, we know we need:</p>

  <ul>
      <li>A way to create connections (i.e. connection factory)
          <code><pre>let newConnection connectionString =
      let conn = new SqlConnection(connectionString)
      conn.Open()
      conn</pre></code>
      </li>
      <li>A way to execute statements (i.e. INSERT, UPDATE)
          <code><pre>let exec sql param conn =
      let cmd = newCommand sql param conn
      cmd.ExecuteNonQuery()</pre></code>
      </li>
      <li>A way to query records (i.e. SELECT)
          <code><pre>let query sql param map conn =
      let cmd = newCommand sql param conn
      use rd = cmd.ExecuteReader()
      [ while rd.Read() do
          yield map rd ]</pre></code>
      </li>
  </ul>

  <p>To support the above syntax we'll create ourselves a module called SQL, import <code>System.Data</code> and for this example we'll use <code>System.Data.SqlClient</code> (though you could sub this with any vendor). Once we've gotten our dependencies imported, creating wrapper for ADO becomes trivial.</p>

  <code><pre>module SQL =
  open System.Data
  open System.Data.SqlClient

  let newConnection (connectionString : string) =
      let conn = new SqlConnection(connectionString)
      conn.Open()
      conn

  let createParameter (cmd: SqlCommand) (name : string, value : obj) =
      let p = cmd.CreateParameter()
      p.ParameterName <- name
      p.Value <- value
      p

  let addParameter (cmd: SqlCommand) (p : SqlParameter) = 
      cmd.Parameters.Add(p) |> ignore

  let newCommand 
      (sql : string) 
      (parameters : seq&lt;string * obj&gt; 
      (conn : IDbConnection) =        
      let cmd = new SqlCommand(connection = conn, cmdText = sql)
      cmd.CommandType <- CommandType.Text        

      let createParam = createParameter cmd
      let addParam = addParameter cmd
      parameters 
      |> Seq.iter (fun p -> p |> createParam |> addParam)
      cmd 

  let exec 
      (sql : string) 
      (parameters : seq&lt;string * obj&gt; 
      (conn : IDbConnection) =        
      let cmd = newCommand sql param conn
      cmd.ExecuteNonQuery()

  let query 
      (sql : string) 
      (parameters : seq&lt;string * obj&gt; 
      (conn : IDbConnection) =        
      let cmd = newCommand sql param conn
      use rd = cmd.ExecuteReader()
      [ while rd.Read() do
          yield map rd ]</pre></code>

  <blockquote>Notice that there is mutation happening here (anywhere you see <code><-</code>). But that's okay because we've tucked it away and sand boxed it with a function wrapper.</blockquote>

  <p>So in about 30 lines of code we've created ourselves a small, well-understood and self documenting solution that can help us fully achieve the goal of interacting with a database. Pretty sweet!</p>

  <p>If you find this approach helpful, feel free to checkout my OS project <a href="https://github.com/pimbrouwers/Donald" target="_blank">Donald</a>, a well-tested, idiomatic F# wrapper for ADO.NET (note: it is NOT vendor specific).</p>
  <hr/>

  <footer>
    <div>Pim Brouwers</div>
    <div>Senior Software Architect @ <a href="nhlpa.com" target="_blank">NHLPA</a></div>
    <div>
      <a href="//twitter.com/pim_brouwers" target="_blank">Twitter</a>
      <a href="//github.com/pimbrouwers" target="_blank">GitHub</a>
    </div>
  </footer>
</body>

</html>